## GraphQL Subscription과 WebSocket의 연계
### 1. 기능 설명:
- GraphQL Subscription: 클라이언트가 서버로부터 데이터 변경을 실시간으로 받아볼 수 있도록 하는 GraphQL의 기능입니다. 이는 클라이언트가 정확한 시점에 필요한 데이터를 받아볼 수 있게 해주는 메커니즘을 제공합니다.
- 실시간 푸시: 서버에서 데이터의 변화가 감지되면, 해당 변경 사항이 구독 중인 클라이언트에게 자동으로 푸시됩니다. 이는 폴링(polling) 방식에서 벗어나, 필요한 데이터만을 필요한 시점에 전달하는 효율적인 방법입니다.

### 2. 동작 원리:
- 구독 설정: 클라이언트는 GraphQL 쿼리를 통해 특정 데이터의 변경사항 구독을 서버에 요청합니다. 이 구독 쿼리는 데이터의 특정 부분만을 명시하여, 그 부분이 변경될 때만 알림을 받도록 설정됩니다.
- 이벤트 기반 통신: 서버에서는 데이터 소스를 모니터링하여 변경사항을 감지합니다. 변화가 감지되면, 이를 구독 로직에 의해 처리하고, 해당 이벤트에 대한 정보를 구독 중인 클라이언트들에게 푸시합니다.
- 실시간 반응성: 이 방식은 데이터의 실시간 업데이트를 가능하게 하여, 웹 애플리케이션에서의 사용자 경험을 극대화합니다. 사용자는 데이터가 변경되는 즉시 그 결과를 볼 수 있으며, 이는 특히 동적인 데이터를 다루는 애플리케이션에 있어 큰 장점입니다.

### 3. 연계 방법
![CH14_04. GraphQL Subscription과 WebSocket의 연계.png](CH14_04.%20GraphQL%20Subscription%EA%B3%BC%20WebSocket%EC%9D%98%20%EC%97%B0%EA%B3%84.png)
#### WebSocket 연결 초기화
- 클라이언트:
  - 연결 요청: 클라이언트는 `WebSocket` 프로토콜을 사용하여 서버에 연결 요청을 합니다. 이는 일반적으로 `ws://` 또는 `wss://` (암호화된 연결) URL을 통해 수행됩니다.
  - 핸드셰이크: WebSocket 핸드셰이크 과정을 통해, HTTP 요청이 WebSocket 프로토콜로 업그레이드되며, 서버와 클라이언트 간의 양방향 통신 채널이 확립됩니다.

- 서버:
  - 연결 수락: 서버는 클라이언트의 연결 요청을 검토하고 수락합니다. 이후, 서버는 클라이언트에게 `101 Switching Protocols` 응답을 보내어 연결이 WebSocket으로 전환됨을 알립니다.

#### GraphQL 구독 설정
```json
{
  "type": "start", // start, stop, connection_init 등의 타입을 가질 수 있습니다.
  "id": "1", // 메시지 ID
  "payload": {
    "query": "subscription { messageReceived { id content } }",
    "variables": {}
  }
}
```
- 클라이언트:
  - 구독 요청: 클라이언트는 확립된 WebSocket 연결을 통해 GraphQL 구독 쿼리를 전송합니다. 이 쿼리는 JSON 형식으로 구성되며, `type: subscription`과 함께 구독하고자 하는 데이터의 세부 사항을 명시합니다.
- 서버:
  - 쿼리 처리: 서버는 수신된 GraphQL 쿼리를 분석하고, 해당 데이터에 대한 구독을 설정합니다. 이 과정에서 서버는 필요한 리소스 할당 및 이벤트 리스너 설정 등의 작업을 수행합니다.

#### 이벤트 기반 통신 및 데이터 푸시
```json
{
  "type": "data",
  "id": "1",
  "payload": {
    "data": {
      "messageReceived": {
        "id": "123",
        "content": "Hello, this is a new message!"
      }
    }
  }
}
```
- 데이터 소스:
  - 변경 감지: 서버는 연결된 데이터 소스를 모니터링합니다. 데이터에 변화가 발생하면, 이를 감지하고 관련 이벤트를 생성합니다.

- 서버:
  - 데이터 처리 및 푸시: 감지된 데이터 변경에 대해, 서버는 구독 로직에 따라 처리하고, 결과를 구독 중인 클라이언트에게 푸시합니다. 이때, 서버는 WebSocket 프로토콜을 사용하여 JSON 형식의 메시지를 클라이언트에게 전송합니다.

- 클라이언트:
  - 데이터 수신 및 처리: 클라이언트는 서버로부터 푸시된 데이터를 실시간으로 수신합니다. 이 데이터는 클라이언트의 UI나 상태를 업데이트하는 데 사용됩니다.